## 🌈 Chapter 6 : 데이터 압축
MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 일반적으로 쿼리의 처리 성능과도 직결되지만,  
백업 및 복구 시간과도 밀접하게 연결된다.

- 디스크의 데이터 파일이 크면 클수록
  - 쿼리 처리를 위해 많은 데이터 페이지를 InnoDB 버퍼 풀로 읽어야 할 수도 있다.
  - 새로운 페이지가 버퍼 풀로 적재되므로, 그만큼 더티 페이지가 더 자주 디스크로 기록돼야 한다.
  - 백업 시간 및 복구 시간 증가
  - 비용 문제

많은 DBMS가 위와 같은 문제를 해결하기 위해 데이터 압축기능을 제공한다.

MySQL 서버에서 사용 가능한 압축 방식은 크게 테이블 압축과 페이지 압축의 두 가지 종류로 구분할 수 있는데,  
두 방식은 매우 다르게 작동하므로 하나씩 구분해서 살펴보자.

### 📚 LESSON 1 : 페이지 압축
페이지 압축은 Transparent Page Compression이라고도 불리는데,

MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고,   
반대로 MySQL 서버가 디스크에서 데이터 페이지를 일겅올 때 압축이 해제되기 때문이다.

즉 버퍼 풀에 데이터 페이지가 한 번 적재되면 InnoDB는 압축이 해제된 상태로만 데이터 페이지를 관리한다.   
그래서 MySQL 내부 코드에서는 압축 여부와 관계없이 투명(Transprent)하게 작동한다.

그렇다면 16KB 데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가능한데   
적어도 **하나의 테이블은 동일한 크기의 페이지(블록)로 통일**돼야 한다는 것이다.

그래서 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 **펀치 홀(Punch hole)** 이라는 기능을 사용한다.

페이지 압축 방식은 다음과 같다.

[그림 6-1]

- 16KB 페이지를 압축(압축 결과를 7KB로 가정)
- MySQL 서버는 디스크에 압축된 결과 7KB를 기록
  - 이때 MySQL 서버는 압축 대에터 7KB에 9KB의 빈 데이터를 기록
- 디스크에 데이터를 기록한 후, 7KB 이후의 공간 9KB에 대해 펀치 홀을 생성
- 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB 공간은 다시 운영체제로 반납

실제 디스크 공간은 7KB만 차지하지만, 운영체제에서는 압축된 7KB와 펀치 홀 공간인 9KB를 합쳐 16KB를 읽는다.

하지만 이 MySQL의 압축 방식은 여러 문제가 있다.
- 펀치홀 기능을 운영체제뿐 아니라 하드웨어 자체에서도 지원해야 사용가능하다.
- 파일 시스템 관련 명령어(유틸리티)가 펀치 홀을 지원하지 못한다.
- MySQL 서버의, 데이터 파일은 해당 서버에만 머무는 것이 아니다.
- 백업했다 복구하는 과정에서 데이터 파일 복사 과정이 실행되기도한다.
- 그 외에도 많은 파일 관련 유틸리티들을 사용한다.
  
  > Ex) 펀치 홀이 적용되어 실제 데이터 파일의 크기가 1GB라고 하더라도 "cp"같은 파일 복사 명령 또는 XtraBackup 같은 툴이    
  > 파일을 복사하면 펀치 홀이 다시 채워져 데이터 파일의 크기는 원본 크기인 10GB일 수 있다.

이러한 이유로 실제 페이지 압축은 많이 사용되지 않는 상태다.

페이지 압축을 이용하기 위해서는 테이블을 생성 및 변경시 다음과 같이 COMPRESSION 옵션을 설정하면 된다.

- 테이블 생성
  - `CREATE TABLE t1 (c1 INT) COMPRESSION="zlib"`
- 테이블 변경
  - `ALTER TABLE t1 COMPRESSION="zlib"`
  - `OPTIMIZE TABLE t1`
