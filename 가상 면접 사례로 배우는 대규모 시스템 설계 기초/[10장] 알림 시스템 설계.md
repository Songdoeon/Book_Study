## 🌈 Chapter 10 : 알림 시스템 설계

<details><summary>정리</summary>

```
- 알림은 중요 정보를 계속 알려준다는 점에서 필요불가결한 기능이다.
- 이번 장에서 우리는 규모 확장성 그리고 다양한 정보 전달 방식을 지원하는 알림 시스템을 만들었다.
- 시스템 컴포넌트 사이의 결합도를 낮추기 위해 메시지 큐를 사용 하였다.
- 특히 아래에 주제에 대해 집중하였다.
  - 안정성 : 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 도입
  - 보안 : 인증된 클라이언트만이 알림을 보낼 수 있도록 하였다.
  - 이텐트 추적 및 모니터링 : 알림이 만들어 진 후 성공적으로 전송 되기까지의 과정을 추적하고 시스템 상태를 모니터링 하기 위해 알림 전송의 각 단계마다 이벤트를 추적하고 모니터링 할 수 있는 시스템을 통합하였다.
  - 사용자 설정 : 사용자가 알림 수신 설정을 조정할 수 있도록 하였다. 따라서 알림을 보내기 전 반드시 해당 설정을 확인하도록 시스템 설계를 변경하였다.
  - 전송률 제한 : 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 하였다.

```

</details>

알림 시스템은 최근 많은 프로그램이 채택한 인기 있는 기능이다.

이 기능을 갖춘 애플리케이션은 최신 뉴스, 제품 업데이트, 이벤트, 선물 등 고객에게 중요할 만한 정보를 비동기적으로 제공한다.

알림 시스템은 단순 모바일 푸시 알림에 한정 되지 않는다. SMS 메시지, 이메일도 알림 시스템으로 분류할 수 있다.

## 📚 1단계 : 문제 이해 및 설계 범위 확정
하루 백만 건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는게 쉬운 과제는 아니다.

알림 시스템이 어떻게 구현되는지에 대한 깊은 이해가 필요한 작업이다.

> 지원자: 이 시스템은 어떤 종류의 알림을 지원해야 하나요?
> 
> 면접관: 푸시 알림, SMS 메시지 그리고 이메일입니다.
> 
> 지원자: 실시간 시스템이어야 하나요?
> 
> 면접관: 연성 실시간(soft real-time) 시스템이라고 가정합니다. 알림은 가능한 빨리 전달되어야 하지만 시스템에 높은 부하가 있다면 약간의 지연은 무방합니다.
> 
> 지원자: 어떤 종류의 단말을 지원해야 하나요?
> 
> 면접관: iOS, 안드로이드, 그리고 랩탑, 데스크탑 입니다.
> 
> 지원자: 사용자에게 보낼 알림은 누가 만들 수 있나요?
> 
> 면접관: 클라이언트 애플리케이션 프로그램이 만들 수도 있구요, 서버측에서 스케줄링 할 수도 있습니다.
> 
> 지원자: 사용자가 알림을 받지 않도록 설정할 수도 있어야 하나요?
> 
> 면접관: 네 해당 설정을 마친 사용자는 더 이상 알림을 받지 않습니다.
>
> 지원자: 하루에 몇건의 알림을 보낼 수 있어야 하나요?
>
> 면접관: 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 합니다.
> 

## 📚 2단계 : 개략적 설계안 제시 및 동의 구하기

iOS, 안드로이드 푸시알림, SMS 메시지 그리고 이메일을 지원하는 알림 시스템의 개략적 설계안을 살펴보자.

다음과 같은 내용들이 있다.
- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

### 🎈 알림 유형별 지원 방안
우선 각각의 알림 메커니즘이 어떻게 동작하는지 알아보자.

#### 📕 iOS 푸시 알림
iOS에서 푸시 알림을 보내는 순서이다.

알림 제공자 → APNS → iOS 단말

- 알림 제공자(provider)
  - 알림 요청을 만들어 애플 푸시 알림 서비스로 보내는 주체다.
  - 알림 요청에는 다음과 같은 데이터가 필요하다
    - 단말 토큰(device token) : 알람 요청을 보내는 데  필요한 고유 식별자다.
    - 페이로드(payload) : 알림 내용을 담은 JSON 딕셔너리다.
- 애플 푸시 알림 서비스(APNS)
  - 애플이 제공하는 원격 서비스다.
  - 푸시 알림을 iOS 장치로 보내는 역할을 담당한다.
- IOS 단말기(device)
  - 푸시 알림을 수신하는 사용자 단말이다.
 
#### 📕 안드로이드 푸시 알림

안드로이드 푸시알림도 비슷한 절차이다.

알림 제공자 → FCM(Firebase Cloud Messaging) → 안드로이드 단말

#### 📕 SMS 메시지
SMS 메시지를 보낼 때는 보통 데3 사업자의 서비스를 많이 이용한다.

알림 제공자 → SMS 서비스 → SMS 수신 단말기

#### 📕 이메일
대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있다.

그럼에도 많은 회사가 상용 이메일 서비스를 이용한다. 전송 성공률도 높고, 데이터 분석 서비스도 제공한다.

알림 제공자 → 이메일 서비스 → 이메일 수신 단말

### 🎈 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.

사용자가 앱을 설치하거나 처음 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장하다.

데이터베이스에 연락처 정보를 저장할 테이블 구조는 다음과 같다.

<img src = "https://github.com/Songdoeon/Book_Study/assets/96420547/00c1baf7-7b2d-42e6-9438-334860402a89" width = 650 height = 300>

한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 한다는 점을 고려한 설계이다.

### 🎈 알림 전송 및 수신 절차
개략적 설계 이후 점차 최적화 하는 방식으로 진행한다.

#### 📕 초안
- 1부터 N까지의 서비스
  - 이 서비스 각각은 마이크로서비스, 크론잡 또는 분산 시스템 컴포넌트일 수 있다.
  - Ex) 납기일 알림 서비스, 배송 알림을 보내는 쇼핑몰 웹사이트
- 알림 시스템(notification system)
  - 알림 시스템은 알림 전송 / 수신 처리의 핵심이다.
  - 이 시스템은 서비스 모두에게 알림 전송을 위한 API를 제공해야한다.
  - 제3자 서비스에 전달할 알림 페이로드(payLoad)를 만들어 낼 수 있어야 한다.
- 제3자 서비스(third party services)
  - 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다.
  - 제3자 서비스와의 통합을 진행할 때 유의할 것은 확장성이다.
    - 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 함
  - 특정 서비스는 다른 시장에서 사용할 수 없을 수도 있다.
    - 중국 시장에서는 FCM 대신 제이푸시, 푸시와이 같은 서비스를 사용해야만 한다.
- 단말기
  - 사용자는 자기 단말에서 알림을 수신한다.
 
이 설계에는 몇 가지 문제가 있다.

- SPOF(Single-Point-Of-Failure)
  - 알림 서비스에 서버가 하나라는것은 그 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는뜻이다.
- 규모 확장성
  - 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하는 것은 좋지 못하다.
  - DB, 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 필요함
- 성능 병목
  - 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업이다.
  - Ex)HTML 페이지를 만들고 제3자 서비스의 응답을 기다리는 일은 시간이 많이 걸릴 가능성이 높다.
  - 따라서 모든것을 한 서버로 처리하면 트래픽이 많이 몰리는 시간에 시스템 과부하 상태에 빠질 수 있다.

#### 📕 개선된 설계안
초안의 문제점을 바탕으로 다음과 같은 방향으로 개선해 보자

- DB와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

다음 설계를 왼쪽부터 살펴보자

![image](https://github.com/Songdoeon/Book_Study/assets/96420547/4d9c6ccc-73a2-4a6d-bd55-40c3dd723adb)

- 1부터 N까지의 서비스
  - 알림 시스템 서버의 API를 통해 알림을 보낼 서비스들 이다.
- 알림 서버
  - 알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능하다.
  - 알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적 검증을 수행한다.
  - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능이다.
  - 알림 전송 : 알림 데이터를 메시지 큐에 넣는다.
    - 하나 이상의 메시지 큐 사용으로 알림을 병렬적으로 처리할 수 있다. 
- 캐시
  - 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.
- DB
  - 사용자 , 알림, 설정 등 다양한 정보를 저장한다.
- 메시지 큐
  - 시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다.
  - 다량의 알림이 전송되는 경우를 대비한 버퍼 역할도 한다.
  - 종류별 메시지큐 사용으로 다른 서비스 장애에도 대응 가능하다.

## 📚 3단계 : 상세 설계
지금까지의 개략적 설계를 진행하면서 알림의 종류, 연락처 정보 수집 절차, 그리고 알림 전송/수신 절차에 대해 살펴보았다.

이제 다음 내용을 좀 더 자세히 알아보자.

- 안정성
- 확장 가능한 컴포넌트 및 고려사항
  - 알림 템플릿, 알림 설정, 전송률 제한, 재시도 메커니즘, 보안,
  - 큐에 보관된 알림에 대한 모니터링
  - 이벤트 추적
- 개선된 설계안

### 🎈 안정성
분산 환경에서 운영 될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇가지를 반드시 고려해야 한다.

데이터 손실 방지
- 알림 전송 시스템의 가장 중요한 요구사항 가운데 하나는 어떤 상황에서도 알림이 소실되면 안된다는것이다.
- 알림 시스템은 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 한다.
- 알림 로그 DB를 유지하는 것이 한 가지 방법이다.

알림 중복 전송 방지
- 같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 가능하지 않다.
- 분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송 하기도 할 것이다.
- 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 중복 체크를 한다.

### 🎈 확장 가능한 컴포넌트 및 고려사항
알림 템플릿
- 대형 알림 시스템은 하루에도 수백만 건 이상의 알림을 처리한다.
- 하지만 대부분의 형식이 유사하기에 템플릿으로 공통 부분을 제작해둔다.
- 인자나 스타일, 추척링크를 조정하여 사전에 지정한 형식에 맞춰 알람을 만들어낸다.
- 알림들의 형식을 일관성 있게 유지할 수 있고, 오류 가능성 뿐 아니라 작성 시간도 줄일 수 있다.

알림 설정
- 사용자가 알림 설정을 상세히 조정할 수 있어야 한다.
- 알림을 보내기전 알림 설정 테이블 데이터를 확인하고 보낸다.

|user_id|bigint||
|--|--|--|
|channel|varchar|알림이 전송될 채널. 푸시 알림, 이메일, SMS 등|
|opt_in|boolean|해당 채널로 알림을 받을 것인지의 여부|

전송률 제한
- 한 사용자가 받을 수 있는 알림의 빈도를 제한하는 것이다.
- 알림을 너무 많이 보내면 사용자가 기능을 꺼 버릴 수도 있다.

재시도 방법
- 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다.
- 같은 문제가 계속 발생시 개발자에게 통지한다(alert)

푸시 알림과 보안
- iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다.
- 따라서 인증, 승인된 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있다.

큐 모니터링
- 알림 시스템을 모니터링 할 때 중요한 메트릭(metric)하나는 큐에 쌓인 알림의 개수이다.
- 수가 너무 크면 이벤트를 빠르게 처리하고 있지 못하다는 뜻이다.
- 그런 경우 작업 서버 증설이 필요할 수 있다.

이벤트 추적
- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다.
- 보통 알림 시스템을 만들면 데이터 분석 서비스와도 통합해야한다.

### 🎈 수정된 설계안
![image](https://github.com/Songdoeon/Book_Study/assets/96420547/05d95fc0-b994-4293-9cd2-dc3af080436a)

- 알림 서버에 인증과 전송률 제한 기능이 추가되었다.
- 전송 실패에 대응하기 위한 재시도 기능이 추가되었다.
- 전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다.
- 모니터링과 추적 시스템을 추가하여 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 하였다.
