## 🌈 Chapter 12 : 채팅 시스템 설계

<details><summary>정리</summary>
  
```

```

</details>

구글 검색 또는 아마존 웹 사이트 검색창에 단어를 입력하다 보면 입력중인 글자에 맞는 검색어가 자동으로 완성되어 표시되는 것을 볼 수 있다.

이런 기능은 보통 검색어 자동완성 이라부른다. 우리는 많이 이용된 검색어 k개를 자동완성하여 출력하는 시스템을 설계해 보도록 하겠다.

##  📚 1단계 : 문제 이해 및 설계 범위 확정

> 지원자: 사용자가 입력하는 단어는 자동완성될 검색어의 첫 부분이어야 하나요? 아니면 중간 부분이 될 수도 있습니까?
> 
> 면접관: 첫 부분으로 한정하겠습니다.
>
> 지원자: 몇 개의 자동완성 검색어가 표시되어야합니까?
> 
> 면접관: 5개입니다.
> 
> 지원자: 자동완성 검색어 5개를 고르는 기준은 무엇입니까?
> 
> 면접관: 질의 빈ㄷ에 따라 정해지는 검색어 인기 순위를 기준으로 삼겠습니다.
> 
> 지원자: 맞춤법 검사 기능도 제공해야 합니까?
> 
> 면접관: 아뇨 맞춤법 검사나 자동수정은 지원하지 않습니다.
> 
> 지원자: 질의는 영어입니까?
> 
> 면접관: 네. 하지만 시간이 허락한다면 다국어 지원을 생각해도 좋습니다.
> 
> 지원자: 대문자나 특수 문자 처리도 해야 합니까?
> 
> 면접관: 아뇨 모든 질의는 영어 소문자로 이루어진다고 가정하겠습니다.
> 
> 지원자: 얼마나 많은 사용자를 지원해야 합니까?
> 
> 면접관: 일간 능동 사용자(DAU) 기준으로 천만명 입니다.

### 🎈 요구사항

위의 요구사항을 정리해 보았다.

- 빠른 응답 속도
  - 사용자가 검색어를 입력함에 따라 자동완성 검색어도 충분히 빨리 표시되어야 한다.
  - 페이스북 검색어 자동완성 시스템에 관한 문서를 보면 시스템 응답속도는 100ms 이내여야 한다.
- 연관성
  - 자동완성되어 출력되는 검색어는 사용자가 입력한 단어와 연관된 것이어야 한다.
- 정렬
  - 시스템의 계산 결과는 인기도(popularity) 등의 순위 모델(ranking model)에 의해 정렬되어 있어야 한다.
- 규모 확장성
  - 시스템은 많은 트래픽을 감당할 수 있도록 확장 가능해야 한다.
- 고가용성
  - 시스템의 일부에 장애가 발생하거나, 느려지거나, 예상치 못한 네트워크 문제가 생겨도 시스템은 계속 사용 가능해야 한다.
 

### 🎈 개략적 규모 추정

- DAU는 천만 명으로 가정한다.
- 평균적으로 한 사용자는 매일 10건의 검색을 수행한다고 가정한다.
- 질의할 때마다 평균적으로 20바이트의 데이터를 입력한다고 가정한다
  - 문자 인코딩 방법으로는 ACSII를 사용한다고 가정한다(1문자 == 1바이트)
  - 질의문은 평균적으로 4개 단어로 이루어진다고 가정할 것이며, 각 단어는 평균 5글자로 구정된다.
  - 따라서 질의당 평균 4 x 5 = 20바이트 이다.
- 검색창에 글자를 입력할 때 마다 클라이언트는 검색어 자동완성 백엔드에 요청을 보낸다.
  - 따라서 평균 1회검색당 20건의 요청이 백엔드로 전달된다.(한글자 당 한번)
- 대략 초당 24,000건의 질의(QPS)가 발생할 것이다.
  - 10,000,000 사용자 x 10질의 x 20자 / 3600(초)
- 최대 QPS = QPS x 2 = 대략 48000건
- 질의 가운데 20% 정도는 신규 검색어라고 가정할 것이다.
  - 따라서 매일 대략 0.4GB 정도의 신규 데이터가 시스템에 추가된다.

##  📚 2단계 : 개략적 설계안 제시 및 동의 구하기

개략적으로 보면 시스템은 두 부분으로 나뉜다.

- 데이터 수집 서비스(data gathering service)
  - 사용자가 입력한 질의를 실시간으로 수집하는 시스템이다.
  - 데이터가 많은 애플리케이션에 실시간 시스템은 그다지 바람직 않지만 설계안을 만드는 출발점으로는 괜찮다.
  - 상세 설계안을 준비할 때 보다 현실적인 안으로 교체하도록 하겠다.
- 질의 서비스(query service)
  - 주어진 질의에 다섯 개의 인기 검색어를 정렬해 내놓는 서비스이다.

### 🎈 데이터 수집 서비스
질의문과 사용빈도를 저장하는 빈도 테이블(frequency table)이 있다고 가정하겠다.

사용자가 twitch, twitter, twitter, twillo를 순서대로 검색하면 다음과 같이 바뀌어 나가게 된다.
![image](https://github.com/Songdoeon/Book_Study/assets/96420547/f33f5354-2b8b-47f0-b839-53d9a00054bc)

### 🎈 질의 서비스

<img src = "https://github.com/Songdoeon/Book_Study/assets/96420547/60bef609-af00-4a2c-8244-70d7b9a2bcea" width = 240 height = 350>

- query
  - 질의문을 저장하는 필드
- frequency
  - 질의문이 사용된 빈도를 저장하는 필드

<img src = "https://github.com/Songdoeon/Book_Study/assets/96420547/fb83b0b4-0930-4401-9453-4ebc57957328" width = 400 height = 350>

사용자가 `tw`를 검색창에 입력하면 "top 5" 자동완성 검색어가 표시되어야 한다.



```sql
SELECT * FROM frequency_table
WHERE query LIKE `prefix%`
ORDER BY frequency DESC
LIMIT 5;
```
가장 많이 사용된 5개 검색어는 다음과 같이 계산할 수 있다.

데이터 양이 적을 때는 나쁘지 않은 설계안이지만, 데이터가 아주 많아지면 데이터베이스가 병목이 될 수 있다.


##  📚 3단계 : 상세 걸계

데이터 수집 서비스와 질의 서비스의 두 부분으로 구성된 개략적 설계안은 최적화된 결과물이라 말하기 어렵지만 출발점으로서는 썩 괜찮은 안이었다.

이번 절에서는 컴포넌트를 몇 개 골라 더 상세히 설계하고 다음 순서로 최적화 방안을 논의할 것이다.

- 트라이(trie) 자료구조
- 데이터 수집 서비스
- 질의 서비스
- 규모 확장이 가능한 저장소
- 트라이 연산

### 🎈 트라이 자료구조
개략적 설계안에서는 관계형 RDBMS를 저장소로 사용했었다.

하지만 RDBMS를 이용해 가장 인기있었던 다섯 개 질의문을 골라내는 방안은 효율적이지 않다.

이 문제는 트라이를 사용해 해결할 것이다. 트라이가 시스템의 핵심적 부분이 될 것이므로, 충분한 시간을 할애하여 주어진 요구사항에 딱 맞는 트라이를 만들도록 할 것이다.

> 트라이(trie) : 접투어 트리(prefix tree) 라고도 하며 문자열을 꺼내는 연산에 초점을 맞춘 자료구조다.

- 트라이는 트리 형태의 자료구조다.
- 이 트리의 루트 노드는 . 빈문자열을 나타낸다.
- 각 노드는 글자 하나를 저장하며, 26개의 자식 노드를 가질 수 있다.
- 각 트리 노드는 하나의 단어 또는 접두어 문자열을 나타낸다.
- 




