## 🌈 Chapter 14 : 유튜브 설계

<details><summary>정리</summary>
  
```
```

</details>

이번 장에서는 유튜브 시스템을 설계해볼것이다.

이 문제에 대한 답은 넷플릭스나 홀루 같은 비디오 플랫폼 설계하는 문제에도 적용 가능하다.

유튜브에 대해 2020년에 조사된 결과다.

- 월간 능도 사용자수(DAU) : 20억 (2billion)
- 매일 재생되는 비디오 수 : 50억 (5billion)
- 미국 성인 중 73% 사용
- 5천만(50million)명의 창작자
- 유튜브 광고 수입은 2019년 기준으로 150억 달러이며 이는 2018년도 대비 36% 증가한 수치
- 모바일 인터넷 트래픽 가운데 37% 유튜브가 점유
- 80개 언어로 이용 가능

##  📚 1단계 : 문제 이해 및 설계 범위 확정
유튜브는 단순 비디오 시청 말고 다른 기능이 많다. 

댓글, 비디오 공유, 좋아요 버튼, 재생목록 저장, 채널 구독 등 여러가지다.

> 지원자: 어떤 기능이 가장 중요한가요?
> 
> 면접관: 비디오를 올리는 기능과 시청하는 기능입니다.
>
> 지원자: 어떤 클라이언트를 지원해야 하나요?
> 
> 면접관: 모바일 앱, 웹 브라우저, 그리고 스마트TV 입니다.
> 
> 지원자: DAU는 몇 명입니까?
> 
> 면접관: 5백만 입니다.
> 
> 지원자: 사용자가 이 제품에 평균적으로 소비하는 시간은 얼마인가요?
> 
> 면접관: 30분입니다.
> 
> 지원자: 다국어 지원이 필요한가요?
> 
> 면접관: 네. 어떤 언어로도 이용 가능 해야합니다.
> 
> 지원자: 어떤 비디오 해상도를 지원해야할까요?
> 
> 면접관: 현존하는 비디오 종류와 해상도 대부분을 지원해야 합니다.
> 
> 지원자: 암호화가 필요할까요?
> 
> 면접관: 네
> 
> 지원자: 비디오 파일 크기에 제한이 있습니까?
> 
> 면접관: 작은 비디오, 혹은 중간 크기 비디오에 초점을 맞추도록 합시다. 비디오 최대 크기는 1GB 입니다.
> 
> 지원자: 아마존이나 구글, MS가 제공하는 클라우드 서비스를 활용해도 될까요?
>
> 면접관: 모든 걸 바닥부터 쌓아 올리는 것은 대부분 회사에게 비현실적이죠. 활용할 수 있다면 하는 것이 바람직할 것입니다.

우리가 초첨을 맞출 점은 다음이다.

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트 : 모바일 앱, 웹, 스마트 TV

### 🎈 개략적 규모 추정

- DAU : 5백만
- 한 사용자는 하루에 평균 4개의 비디오를 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 5백만 x 10% x 300MB = 150TB
- CDN 비용
  - 클라우드 CDN을 통해 비디오를 서비스할 경우 CDN에서 나가는 데이터의 양에 따라 과금한다.
  - 아마존의 CloudFront를 CDN 솔루션으로 사용할 경우, 100% 트래픽이 미국에서 발생한다고 가정하면 1GB당 $0.02의 요금이 발생한다.
  - 문제를 단순화하기 위해 비디오 스트리밍 비용만 따리도록 하겠다.
  - 따라서 매일 발생하는 요금은 5백만 x 5비디오 x 0.3GB x $0.02 = $150,000 이다.
 
이 추정 결과에 따르면 CDN을 통해 비디오를 서비스하면 비용이 엄청나다.

CSP가 큰 고객에게 비용 할인을 해주는 점을 감안하더라도 비용이 만만찮다. 이 비용을 줄이는 방법에 대해 알아보자

##  📚 2단계 : 개략적 설계안 제시 및 동의 구하기

앞서 예로 들었던 대화에서 면접관은 기존 클라우드 서비스를 이용해도 좋다고 했었다.

따라서 여기서 제시하는 설계안은 CDN과 BLOB 스토리지의 경우에는 기존 클라우드 서비스를 활용할 것이다.

직접 만들지 않는 이유는 다음과 같다.

- 시스템 설계 면접은 모든 것을 밑바닥부터 만드는 것과는 관계가 없다.
  - 주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이 그 기술 각각이 어떻게 동작하는지 상세히 설명하는 것보다 중요하다.
  - 예를 들어 비디오를 저장하기 위해 BLOB 저장소를 쓸 것이라면 그 사실만 언급해도 충분하다.
  - BLOB 저장소를 어떻게 구현할지 설계를 제시하는 것은 지나치다.
- 규모 확장이 쉬운 BLOB 저장소나 CDN을 만드는 것은 지극히 복잡할 뿐 아니라 비용이 많이 든다.
  - 넷플릭스나 페이스북 같은 큰 회사도 모든 것을 스스로 구축하지는 않는다.
  - 넷플릭스는 AWS Cloud 서비스를 사용하고 페이스북은 아카마이의 CDN을 사용한다.

개략적으로 이 시스템은 다음 세 개 컴포넌트로 구성된다.

- 단말(client)
  - 컴퓨터, 모바일 폰, 스마트 TV를 통해서 유튜브를 시청할 수 있다.
- CDN
  - 비디오는 CDN에 저장한다. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어진다.
- API 서버
  - 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다.
  - 피드 추천, 비디오 업로드 URL 생성, 메타데이터 DB와 캐시 갱신, 사용자 가입 등등이 API 서버가 처리하는 작업이다.
 
면접관이 다음 두 영역을 설계해 줄 것을 요청했다고 가정하자

- 비디오 업로드 절차
- 비디오 스트리밍 절차

### 🎈 비디오 업로드 절차

다음은 비디오 업로드 절차의 개략적 설계안이다.
![image](https://github.com/Songdoeon/Book_Study/assets/96420547/b7614477-b156-4b24-8a79-033fb44fdd54)

- 사용자
  - 컴퓨터나 모바일 폰, 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자다.
- 로드맬런서(load balancer)
  - API 서버 각각으로 고르게 요청을 분산하는 역할을 담당한다.
- API 서버
  - 비디오 스트리밍을 제외한 다른 모든 요청을 처리한다.
- 메타데이터 DB
  - 비디오의 메타데이터를 보관한다.
  - 샤딩과 다중화를 적용하여 성능 및 가용성 요구사항을 충족한다.
- 메타데이터 캐시
  - 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시한다.
- 원본 저장소
  - 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB) 시스템이다.
- 트랜스코딩 서버
  - 비디오 트랜스코딩은 비디오 인코딩이라 부르기도 하는 절차다.
  - 비디오의 포맷(MPEG, HLS 등)을 변환하는 절차다.
  - 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소
  - 트랜스코딩이 완료된 비디오를 저장하느 BLOB 저장소다.
- CDN
  - 비디오를 캐시하는 역할을 담당한다.
  - 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 이루어진다.
- 트랜스코딩 완료 큐
  - 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐다.
- 트랜스코딩 완료 핸들러
  - 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들이다.
    
  
  > BLOB : Binary Large Object storage 의 약자로 이진 데이터를 하나의 개체로 보관하는 DBMS다.
  >
  
