## 🌈 Chapter 12 : 채팅 시스템 설계

<details><summary>정리</summary>
  
```

```

</details>

이번 장에서는 채팅 시스템을 설계 해볼 것이다.

Ex) Facebook Messenger, Discord, Line 등등

##  📚 1단계 : 문제 이해 및 설계 범위 확정

채팅 시스템은 여러가지 방향성이 있다.

- 1:1 채팅에 집중하는 앱
  - Ex) 페이스북 메신저
- 그룹 채팅에 중점을 둔 업무용 앱
  - Slack
- 게임 채팅에 쓰이는 대규모 그룹의 소통과 응답지연이 낮은 음성채팅
  - 디스코드

따라서 우리는 어떤 방향성에서 채팅앱을 개발할지 정해야한다.

> 지원자: 어떤 앱을 설계해야 하나요? 1:! 채팅 앱입니까 아니면 그룹 채팅입니까
> 
> 면접관: 둘 다 지원해야 합니다.
>
> 지원자: 모바일 앱을 위한 시스템인가요? 아니면 웹?
> 
> 면접관: 둘 다 입니다.
> 
> 지원자: 처리해야 하는 트래픽 듀모는 어느 정도입니까?
> 
> 면접관: 일병 능동 사용자 수(DAU : Daily Active User) 기준으로 5천만명을 처리할 수 있어야 합니다.
> 
> 지원자: 그룹 채팅의 경우 인원 제한이 있습니까?
> 
> 면접관: 최대 100명 입니다.
> 
> 지원자: 중요 기능은 어떤 것이 있나요? 가령, 첨부파일도 지원할 수 있어야 하나요?
> 
> 면접관: 1:1 채팅, 그룹채팅, 사용자 접속상태 표시를 지원해야 합니다. 덱스트 메시지만 주고받을 수 있습니다.
> 
> 지원자: 메시지 길이에 제한이 있나요?
> 
> 면접관: 네 100,000자 이하 입니다.
>
> 지원자: 종단 간 암호화를 지원해야 하나요?
>
> 면접관: 햔재로서는 필요 없습니다만 시간이 허락하면 논의해볼 수 있겠습니다.
>
> 지원자: 채팅 이력을 얼마나 오래 보관해야 할까요?
>
> 면접관: 영원히요.

이 앱의 기능은 다음과 같다.
- 응답 지연이 낮은 일대일 채팅 기능
- 최대 100명까지 참여할 수 있는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
- 푸시알림
- 5천만 DAU를 처리할 수 있는 구조

##  📚 2단계 : 문제 이해 및 설계 범위 확정

이 문제에 훌륭한 답을 내기 위해서는 클라이언트와 서버의 통신 방법에 대한 기본 지식이 필요하다.

채팅 시스템의 경우 클라이언트는 모바일 앱이거나, 웹 애플리케이션이다. 클아이언트는 서로 직접 통신하지 않는다. 대신 각 클라이언트는 위에 나열한 모든 기능을 지원하는 채팅 서비스와 통신한다.

우선 기본 기능에 집중한다. 이 채팅 서비스는 아래 기능을 제공해야한다.

- 클라이언트들로부터 메시지 수신
- 메시지 수신자recipient) 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관

![image](https://github.com/Songdoeon/Book_Study/assets/96420547/725800a2-50e8-417e-88fc-8a4e046bb72b)

어떤 통신 프로토콜을 사용할 것인가도 중요한 문제다.

- 대부분의 클라이언트/서버 애플리케이션에서 요청을 보내는 것은 클라이언트인데 채팅시스템도 마찬가지다.
- 메시지 송신 클라이언트가 이 역할을 한다.
- 송신 클라이언트는 수신 클라이언트에게 전달할 메시지를 채팅 서비스에 보낼 때, 오랜 세월 검증된 HTTP 프로토콜을 사용한다.
  - HTTP는 현재 웹에서 가장 널리 사용되는 프로토콜이다.
- 클라이언트는 채팅 서비스에 HTTP 프로토콜로 연결한 다음 메시지를 보내어 수신자에게 해당 메시지를 전달하라고 알린다.
- 채팅 서비스와의 접속에는 Keep-alive 헤더를 사용하면 효율적이다.
  - 클라이언트와 서버 사이의 연결을 끊지 않고 계속 유지할 수 있어서이다.
  - TCP 접속 과정에서 발생하는 핸드셰이크 횟수를 줄일 수 있음은 물론이다.
- HTTP는 메시지 전송 용도로는 괜찮은 선택이다.
  - 페이스북 같은 많은 대중적 채팅 프로그램이 초기에 HTTP를 사용했다.


하지만 메시지 수신 시나리오는 이것보다 복잡하다. 
- HTTP는 클라이언트가 연결을 만드는 프로토콜이며 서버에서 클라이언트로 임의 시점에 메시지를 보내는 데는 쉽게 쓰일 수 없다.
- 서버가 연결을 만드는 것처럼 동작할 수 있도록 하기 위해 많은 기법이 제안되어 왔다.
  - 폴링, 롱 폴링, 웹소켓 등이 그런 기술이다.

### 🎈 폴링
폴링은 클라이언트가 주기적으로 서버에게 새 메시지가 있느냐고 물어보는 방법이다. 폴링 비용은 폴리을 자주하면 할수록 올라간다.

답해줄 메시지가 없는 경우에는 서버 자원이 불필요하게 낭비된다는 문제도 있다.

